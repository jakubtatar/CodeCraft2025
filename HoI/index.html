<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <title>Slovak Front: Total Logistics</title>
    <style>
        :root { 
            --bg: #1a202c; --panel: #171923; --border: #2d3748; 
            --accent: #3182ce; --text: #e2e8f0; --gold: #d69e2e; 
            --danger: #e53e3e; --success: #38a169;
        }
        body { margin: 0; overflow: hidden; background: #0f1115; color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; }
        
        #game-layer { flex-grow: 1; position: relative; cursor: crosshair; background: #0f1115; }
        canvas { display: block; }

        /* UI */
        #sidebar { width: 400px; background: var(--panel); border-left: 2px solid var(--border); display: flex; flex-direction: column; z-index: 10; box-shadow: -5px 0 20px rgba(0,0,0,0.7); }
        .top-stats { padding: 15px; background: #000; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center; border-bottom: 1px solid #333; font-weight: bold; }
        
        .inspector { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .card { background: #2d3748; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #4a5568; }
        .card h3 { margin: 0 0 10px 0; border-bottom: 1px solid #555; padding-bottom: 5px; }

        /* BUTTONS */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button { padding: 10px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: 600; transition: 0.2s; background: #4a5568; text-align: left; }
        button:hover:not(:disabled) { filter: brightness(1.2); }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        
        .btn-atk { background: var(--danger); width: 100%; margin-top: 10px; text-align: center; font-size: 1.1em; }
        .btn-move { background: var(--accent); width: 100%; margin-top: 10px; text-align: center; }
        
        .log-box { height: 180px; background: #000; padding: 10px; font-family: monospace; font-size: 0.8em; overflow-y: auto; color: #a0aec0; border-top: 1px solid #333; }
        .msg-warn { color: #feb2b2; } .msg-good { color: #9ae6b4; }

        /* TOOLTIP */
        .tooltip { position: absolute; background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 4px; pointer-events: none; display: none; border: 1px solid #555; z-index: 100; }
    </style>
</head>
<body>

<div id="game-layer">
    <canvas id="gameCanvas"></canvas>
    <div id="tooltip" class="tooltip"></div>
</div>

<div id="sidebar">
    <div class="top-stats">
        <span style="color:#68d391">üíµ <span id="ui-money">0</span></span>
        <span style="color:#cbd5e0">üî© <span id="ui-steel">0</span></span>
        <span style="color:#ecc94b">üõ¢Ô∏è <span id="ui-fuel">0</span></span>
    </div>

    <div class="inspector" id="inspector">
        <p style="text-align:center; color:#718096; margin-top: 50px;">Klikni na mesto pre detaily.</p>
    </div>

    <div class="log-box" id="gameLog">
        <div>> Hra pripraven√°. Veliteƒæ, ƒçak√°me na rozkazy.</div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- KONFIGUR√ÅCIA ---
const CONFIG = {
    trainSpeed: 3.5, // R√Ωchlej≈°ie vlaky
    truckSpeed: 1.2, // Pomal≈°ie kami√≥ny
    combatTick: 1000,
    aiInterval: 4000
};

// --- ENTITY ---
const TERRAIN = [
    { type: 'mountain', x: 450, y: 300, r: 40 }, // N√≠zke Tatry
    { type: 'mountain', x: 550, y: 200, r: 50 }, // Vysok√© Tatry
    { type: 'water', x: 150, y: 650, w: 200, h: 40 }, // Dunaj
    { type: 'water', x: 350, y: 300, w: 20, h: 150 }, // V√°h (zjednodu≈°en√Ω)
    { type: 'forest', x: 700, y: 300, r: 60 } // Lesy na v√Ωchode
];

const UNITS = {
    INF: { name: "Pechota", cost: 50, steel: 0, fuel: 0, att: 2, def: 5 },
    TANK: { name: "Tanky", cost: 300, steel: 50, fuel: 20, att: 30, def: 15 },
    ART: { name: "Del√°", cost: 200, steel: 30, fuel: 5, att: 45, def: 5 },
    AIR: { name: "Letectvo", cost: 600, steel: 10, fuel: 50, att: 60, def: 10 }
};

const BUILDINGS = {
    FACTORY: { name: "Tov√°re≈à", cost: 500, icon: "üè≠" },
    FORT: { name: "Pevnos≈•", cost: 800, icon: "üõ°Ô∏è" }, // Nov√©
    RAILHUB: { name: "Stanica", cost: 400, icon: "üöâ" }
};

let gameState = {
    money: 2000, steel: 200, fuel: 500,
    nodes: [],
    connections: [],
    vehicles: [],
    projectiles: [],
    particles: []
};

// --- INICIALIZ√ÅCIA MAPY (15+ miest) ---
function initMap() {
    // Defin√≠cia miest
    const cities = [
        { id: 0, name: "Bratislava", x: 100, y: 600, owner: 'player', fac: 2 },
        { id: 1, name: "Trnava", x: 180, y: 520, owner: 'player', fac: 1 },
        { id: 2, name: "Nitra", x: 250, y: 580, owner: 'player', fac: 1 },
        { id: 3, name: "Trenƒç√≠n", x: 280, y: 380, owner: 'neutral', fac: 0 },
        { id: 4, name: "≈Ωilina", x: 380, y: 280, owner: 'neutral', fac: 1 },
        { id: 5, name: "Prievidza", x: 350, y: 450, owner: 'neutral', fac: 0 },
        { id: 6, name: "B. Bystrica", x: 480, y: 420, owner: 'neutral', fac: 1 },
        { id: 7, name: "Zvolen", x: 480, y: 500, owner: 'neutral', fac: 1 },
        { id: 8, name: "Luƒçenec", x: 600, y: 550, owner: 'enemy', fac: 0 },
        { id: 9, name: "Poprad", x: 600, y: 250, owner: 'enemy', fac: 0 },
        { id: 10, name: "Pre≈°ov", x: 750, y: 280, owner: 'enemy', fac: 0 },
        { id: 11, name: "Ko≈°ice", x: 780, y: 380, owner: 'enemy', fac: 3 },
        { id: 12, name: "Michalovce", x: 880, y: 350, owner: 'enemy', fac: 0 },
        { id: 13, name: "Kom√°rno", x: 280, y: 700, owner: 'player', fac: 0 },
        { id: 14, name: "Martin", x: 420, y: 320, owner: 'neutral', fac: 0 }
    ];

    cities.forEach(c => {
        gameState.nodes.push({
            ...c,
            units: { INF: 10, TANK: 0, ART: 0, AIR: 0 },
            buildings: { FACTORY: c.fac, FORT: 0, RAILHUB: 0 },
            villages: [0,0,0,0,0], // 0=neutral/enemy, 1=player owned
            hp: 100 // HP hlavn√©ho mesta
        });
    });

    // Defin√≠cia spojen√≠ (Odkiaƒæ -> Kam)
    const links = [
        [0,1], [0,13], [1,2], [1,3], [2,7], [2,13],
        [3,4], [3,5], [4,14], [14,6], [5,7], [6,7],
        [4,9], [6,8], [9,10], [10,11], [11,12], [8,11],
        [7,8]
    ];

    links.forEach(l => {
        let n1 = gameState.nodes[l[0]];
        let n2 = gameState.nodes[l[1]];
        
        // Vypoƒç√≠tame Control Point pre B√©zierovu krivku (aby boli cesty zahnut√©)
        let midX = (n1.x + n2.x) / 2;
        let midY = (n1.y + n2.y) / 2;
        // N√°hodn√© vych√Ωlenie pre "prirodzen√Ω" vzhƒæad cesty
        let offset = 40 * (Math.random() > 0.5 ? 1 : -1);
        
        gameState.connections.push({
            from: n1, to: n2,
            cpX: midX + offset, // Control Point X
            cpY: midY + offset, // Control Point Y
            hasBridge: checkBridge(n1.x, n1.y, n2.x, n2.y)
        });
    });
}

function checkBridge(x1, y1, x2, y2) {
    // Jednoduch√° kontrola ƒçi ƒçiara pret√≠na vodu (bounding box)
    return TERRAIN.some(t => t.type === 'water' && 
        Math.min(x1,x2) < t.x + t.w && Math.max(x1,x2) > t.x &&
        Math.min(y1,y2) < t.y + t.h && Math.max(y1,y2) > t.y
    );
}

// --- LOGIKA HRY ---

let selectedNode = null;
let moveSource = null;

function aiTick() {
    // Jednoduch√° AI: N√°jde svoje mest√°, ak m√° zdroje, verbuje, a ak sused√≠ s hr√°ƒçom, √∫toƒç√≠
    gameState.nodes.filter(n => n.owner === 'enemy').forEach(node => {
        // 1. Verbovanie
        if (Math.random() > 0.7) node.units.INF++;
        if (node.buildings.FACTORY > 0 && Math.random() > 0.8) node.units.TANK++;

        // 2. √ötok
        let targets = gameState.connections
            .filter(c => c.from === node || c.to === node)
            .map(c => c.from === node ? c.to : c.from)
            .filter(n => n.owner === 'player');
            
        if (targets.length > 0 && (node.units.TANK > 2 || node.units.INF > 20)) {
            let target = targets[Math.floor(Math.random() * targets.length)];
            launchAttack(node, target, 'enemy');
        }
    });
}

function spawnVehicles() {
    gameState.connections.forEach(c => {
        // Vlaky (ak je RAILHUB alebo len n√°hodne pre efekt)
        if (c.from.owner === c.to.owner) {
            // Kami√≥ny (ƒçastej≈°ie)
            if (Math.random() > 0.95) {
                gameState.vehicles.push({
                    type: 'truck', t: 0, speed: CONFIG.truckSpeed * 0.005,
                    from: c.from, to: c.to, cpX: c.cpX, cpY: c.cpY
                });
            }
            // Vlaky (menej ƒçasto, len na trati)
            if (Math.random() > 0.98) {
                gameState.vehicles.push({
                    type: 'train', t: 0, speed: CONFIG.trainSpeed * 0.005,
                    from: c.from, to: c.to // Vlaky id√∫ rovno (zatiaƒæ)
                });
            }
        }
    });
}

function launchAttack(source, target, side) {
    // Logika √∫toku
    let attackers = source.units;
    let totalAtt = (attackers.INF*2) + (attackers.TANK*30) + (attackers.ART*40) + (attackers.AIR*50);
    
    // Vytvor projektily
    for(let i=0; i<5; i++) {
        gameState.projectiles.push({
            x: source.x, y: source.y, tx: target.x, ty: target.y,
            speed: 0.05 + Math.random()*0.05,
            color: side === 'player' ? '#48bb78' : '#f56565',
            damage: totalAtt / 5,
            side: side
        });
    }

    if(side === 'player') log(`√ötok na ${target.name} spusten√Ω!`, 'good');
    else log(`‚ö†Ô∏è POZOR! Nepriateƒæ √∫toƒç√≠ na ${target.name}!`, 'warn');
}

function resolveHit(p, target) {
    // 1. Zniƒç dediny (Sektory)
    let villageIndex = -1;
    if (p.side === 'player') {
        // Hƒæad√°me ƒçerven√∫ (0) dedinu
        villageIndex = target.villages.findIndex(v => v === 0);
    } else {
        // Hƒæad√°me zelen√∫ (1) dedinu
        villageIndex = target.villages.findIndex(v => v === 1);
    }

    // Bonus obrany z pevnosti
    let defBonus = 1 + (target.buildings.FORT * 1.5);

    if (villageIndex !== -1) {
        // √ötok na dedinu
        if (Math.random() * p.damage > 10 * defBonus) {
            target.villages[villageIndex] = (p.side === 'player') ? 1 : 0;
            createExplosion(target.x + Math.cos(villageIndex)*30, target.y + Math.sin(villageIndex)*30);
        }
    } else {
        // V≈°etky dediny s√∫ obsaden√© -> √∫tok na mesto
        target.hp -= (p.damage / defBonus);
        createExplosion(target.x, target.y);
        
        if (target.hp <= 0) {
            target.owner = p.side;
            target.hp = 50; // Reset HP
            // Reset ded√≠n na farbu nov√©ho majiteƒæa
            target.villages.fill(p.side === 'player' ? 1 : 0);
            log(`Mesto ${target.name} padlo do r√∫k ${p.side.toUpperCase()}!`, 'good');
        }
    }
}

// --- VISUALS ---

function draw() {
    // 1. Pozadie a Ter√©n
    ctx.fillStyle = "#0f1115";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Hory
    TERRAIN.filter(t => t.type === 'mountain').forEach(m => {
        ctx.fillStyle = "#2d3748";
        ctx.beginPath(); ctx.moveTo(m.x, m.y - m.r); ctx.lineTo(m.x + m.r, m.y + m.r); ctx.lineTo(m.x - m.r, m.y + m.r); ctx.fill();
        // Sneh na vrchu
        ctx.fillStyle = "#e2e8f0";
        ctx.beginPath(); ctx.moveTo(m.x, m.y - m.r); ctx.lineTo(m.x + m.r/3, m.y - m.r/3); ctx.lineTo(m.x - m.r/3, m.y - m.r/3); ctx.fill();
    });

    // Voda
    ctx.fillStyle = "#2b6cb0";
    TERRAIN.filter(t => t.type === 'water').forEach(w => {
        if(w.w > 20) ctx.fillRect(w.x, w.y, w.w, w.h);
        else { // Rieka
             ctx.beginPath(); ctx.moveTo(w.x, w.y); 
             ctx.bezierCurveTo(w.x+20, w.y+50, w.x-20, w.y+100, w.x, w.y+w.h);
             ctx.strokeStyle = "#2b6cb0"; ctx.lineWidth = 10; ctx.stroke();
        }
    });

    // Lesy
    TERRAIN.filter(t => t.type === 'forest').forEach(f => {
        ctx.fillStyle = "#276749"; ctx.globalAlpha = 0.6;
        ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1;
    });

    // 2. Cesty a Koƒæaje
    gameState.connections.forEach(c => {
        // Cesta (Krivka)
        ctx.beginPath();
        ctx.moveTo(c.from.x, c.from.y);
        ctx.quadraticCurveTo(c.cpX, c.cpY, c.to.x, c.to.y);
        ctx.strokeStyle = "#4a5568"; ctx.lineWidth = 6; ctx.stroke();

        // Koƒæajnice (Rovn√° ƒçiara pod cestou alebo vedƒæa - pre prehƒæadnos≈• rovno)
        ctx.beginPath();
        ctx.moveTo(c.from.x, c.from.y);
        ctx.lineTo(c.to.x, c.to.y);
        ctx.strokeStyle = "#171923"; ctx.lineWidth = 3; ctx.stroke();

        // Most
        if(c.hasBridge) {
            ctx.strokeStyle = "#a0aec0"; ctx.lineWidth = 12;
            let mx = (c.from.x + c.to.x)/2; let my = (c.from.y + c.to.y)/2;
            ctx.beginPath(); ctx.moveTo(mx-10, my-10); ctx.lineTo(mx+10, my+10); ctx.stroke();
        }
    });

    // 3. Vozidl√°
    gameState.vehicles.forEach((v, i) => {
        v.t += v.speed;
        if(v.t >= 1) { gameState.vehicles.splice(i, 1); return; }
        
        let cx, cy;
        if (v.type === 'truck') {
            // Bezierov vzorec: (1-t)^2 * P0 + 2(1-t)t * P1 + t^2 * P2
            let t = v.t;
            cx = (1-t)*(1-t)*v.from.x + 2*(1-t)*t*v.cpX + t*t*v.to.x;
            cy = (1-t)*(1-t)*v.from.y + 2*(1-t)*t*v.cpY + t*t*v.to.y;
            ctx.fillStyle = "#fff"; ctx.fillRect(cx-3, cy-3, 6, 6);
        } else {
            // Vlak (line√°rny)
            cx = v.from.x + (v.to.x - v.from.x) * v.t;
            cy = v.from.y + (v.to.y - v.from.y) * v.t;
            ctx.fillStyle = "#ecc94b"; ctx.fillRect(cx-6, cy-3, 12, 6);
        }
    });

    // 4. Mest√° a Dediny
    gameState.nodes.forEach(n => {
        // Dediny (Satelity)
        for(let i=0; i<5; i++) {
            let angle = (i / 5) * Math.PI * 2;
            let vx = n.x + Math.cos(angle) * 35;
            let vy = n.y + Math.sin(angle) * 35;
            ctx.beginPath(); ctx.arc(vx, vy, 6, 0, Math.PI*2);
            ctx.fillStyle = n.villages[i] === 1 ? "#48bb78" : (n.owner === 'neutral' ? '#718096' : '#f56565');
            ctx.fill();
        }

        // Hlavn√© mesto
        ctx.beginPath(); ctx.arc(n.x, n.y, 25, 0, Math.PI*2);
        if (n.owner === 'player') ctx.fillStyle = "#3182ce";
        else if (n.owner === 'enemy') ctx.fillStyle = "#e53e3e";
        else ctx.fillStyle = "#718096";
        ctx.fill();
        
        if (n === selectedNode) { ctx.strokeStyle = "white"; ctx.lineWidth = 3; ctx.stroke(); }
        if (n === moveSource) { ctx.strokeStyle = "#ecc94b"; ctx.lineWidth = 3; ctx.stroke(); }

        // Ikony
        ctx.fillStyle = "#fff"; ctx.font = "10px Arial"; ctx.textAlign = "center";
        let ico = "";
        if (n.buildings.FORT) ico += "üõ°Ô∏è";
        if (n.buildings.FACTORY) ico += "üè≠";
        ctx.fillText(ico, n.x, n.y+5);
        
        ctx.font = "bold 12px Segoe UI"; ctx.fillStyle = "#fff";
        ctx.fillText(n.name, n.x, n.y - 30);
    });

    // 5. Projektily & ƒåastice
    gameState.projectiles.forEach((p, i) => {
        p.progress = (p.progress || 0) + p.speed;
        let cx = p.x + (p.tx - p.x) * p.progress;
        let cy = p.y + (p.ty - p.y) * p.progress;
        
        ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI*2); ctx.fill();

        if (p.progress >= 1) {
            let target = gameState.nodes.find(n => Math.hypot(n.x - p.tx, n.y - p.ty) < 40);
            if(target) resolveHit(p, target);
            gameState.projectiles.splice(i, 1);
        }
    });

    gameState.particles.forEach((p, i) => {
        p.life -= 0.05;
        if(p.life <= 0) gameState.particles.splice(i, 1);
        ctx.globalAlpha = p.life; ctx.fillStyle = "orange";
        ctx.beginPath(); ctx.arc(p.x, p.y, 15*(1-p.life), 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1;
    });

    requestAnimationFrame(draw);
}

function createExplosion(x, y) {
    gameState.particles.push({x, y, life: 1});
}

// --- INTERACTION & UI ---

function updateUI() {
    document.getElementById('ui-money').innerText = Math.floor(gameState.money);
    document.getElementById('ui-steel').innerText = Math.floor(gameState.steel);
    document.getElementById('ui-fuel').innerText = Math.floor(gameState.fuel);

    const inspector = document.getElementById('inspector');
    if (!selectedNode) { inspector.innerHTML = "<p style='text-align:center; color:#777'>Vyber mesto</p>"; return; }

    let n = selectedNode;
    let isOwner = n.owner === 'player';
    
    let html = `
        <div class="card">
            <h3>${n.name} ${isOwner ? '(Tvoje)' : (n.owner==='enemy'?'(Nepriateƒæ)':'(Neutr√°lne)')}</h3>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                <span>HP Mesta:</span> <span style="color:${n.hp<50?'orange':'lightgreen'}">${Math.floor(n.hp)}%</span>
            </div>
            <div>Dediny: ${n.villages.filter(v=>v===1).length} / 5 pod kontrolou</div>
        </div>
    `;

    // Jednotky
    html += `<div class="card"><h3>Arm√°da</h3><div class="btn-grid">`;
    for(let k in UNITS) {
        let u = UNITS[k];
        html += `<button onclick="recruit('${k}')" ${!isOwner?'disabled':''}>
            ${u.name} (${n.units[k]})<br><small>$${u.cost} üî©${u.steel}</small>
        </button>`;
    }
    html += `</div></div>`;

    // Stavby
    html += `<div class="card"><h3>Stavby</h3><div class="btn-grid">`;
    for(let k in BUILDINGS) {
        let b = BUILDINGS[k];
        let has = n.buildings[k];
        html += `<button onclick="build('${k}')" ${!isOwner?'disabled':''}>
            ${b.icon} ${b.name} (${has})<br><small>$${b.cost}</small>
        </button>`;
    }
    html += `</div></div>`;

    // Akcie
    if(isOwner) {
        html += `<button class="btn-move" onclick="prepMove()">üöö Pripravi≈• Presun</button>`;
    } else {
        html += `<button class="btn-atk" onclick="playerAttack()">‚öîÔ∏è ZA√öTOƒåI≈§</button>`;
    }

    inspector.innerHTML = html;
}

// Akcie hr√°ƒça
function recruit(type) {
    if(!selectedNode || selectedNode.owner !== 'player') return;
    let u = UNITS[type];
    if(gameState.money >= u.cost && gameState.steel >= u.steel) {
        gameState.money -= u.cost; gameState.steel -= u.steel;
        selectedNode.units[type]++;
        updateUI();
    }
}

function build(type) {
    if(!selectedNode || selectedNode.owner !== 'player') return;
    let b = BUILDINGS[type];
    if(gameState.money >= b.cost) {
        gameState.money -= b.cost;
        selectedNode.buildings[type]++;
        updateUI();
        log(`Postaven√° ${b.name} v ${selectedNode.name}`);
    }
}

function prepMove() { moveSource = selectedNode; log("Vyber cieƒæ pre presun."); }

function playerAttack() {
    if(!moveSource || moveSource.owner !== 'player') { log("Najprv vyber 'Pripravi≈• Presun' zo svojho mesta.", 'warn'); return; }
    if(gameState.fuel < 20) { log("Nedostatok paliva na √∫tok!", 'warn'); return; }
    
    gameState.fuel -= 20;
    launchAttack(moveSource, selectedNode, 'player');
}

function log(msg, type='') {
    let el = document.getElementById('gameLog');
    el.innerHTML = `<div class="${type==='warn'?'msg-warn':(type==='good'?'msg-good':'')}">> ${msg}</div>` + el.innerHTML;
}

// Input Handling
canvas.addEventListener('mousedown', e => {
    let rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left; let y = e.clientY - rect.top;
    
    let clicked = gameState.nodes.find(n => Math.hypot(n.x - x, n.y - y) < 30);
    if(clicked) {
        if(moveSource && moveSource !== clicked && clicked.owner === 'player') {
            // Presun jednotiek
            for(let k in moveSource.units) { clicked.units[k] += moveSource.units[k]; moveSource.units[k] = 0; }
            log("Jednotky presunut√©.");
            moveSource = null;
        }
        selectedNode = clicked;
        updateUI();
    }
});

// Loops
setInterval(() => { // Income
    gameState.nodes.forEach(n => {
        if(n.owner === 'player') {
            gameState.money += 10 + (n.buildings.FACTORY * 50);
            gameState.steel += (n.buildings.FACTORY * 10);
        }
    });
    gameState.fuel += 10;
    updateUI();
    spawnVehicles();
}, 1000);

setInterval(aiTick, CONFIG.aiInterval); // Enemy Logic

// Start
window.onload = () => {
    canvas.width = document.getElementById('game-layer').offsetWidth;
    canvas.height = document.getElementById('game-layer').offsetHeight;
    initMap();
    draw();
};
</script>
</body>
</html>